name: Hotfix Deploy

# 이 워크플로우는 hotfix 브랜치에서 자동으로 빌드 및 테스트를 실행합니다.
# 선택사항: 수동 배포 트리거도 지원합니다.

on:
  push:
    branches:
      - 'hotfix/**'  # hotfix/* 브랜치에 푸시 시 자동 실행
  workflow_dispatch:  # 수동 트리거 지원
    inputs:
      version:
        description: 'Hotfix version (e.g., 0.1.1)'
        required: true
        type: string

jobs:
  # Job 1: 빌드 및 테스트
  build-and-test:
    name: Build and Test Hotfix
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript checks
        run: npm run tsc

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Android Release AAB
        run: |
          cd android
          ./gradlew clean bundleRelease

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v3
        with:
          name: app-release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 7

      - name: Build Android Release APK (for testing)
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v3
        with:
          name: app-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 7

  # Job 2: 알림 (Slack/Discord 등)
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()  # 성공/실패 여부와 관계없이 실행

    steps:
      - name: Send notification
        run: |
          echo "Hotfix build completed"
          echo "Status: ${{ needs.build-and-test.result }}"

          # Slack 알림 (선택사항)
          # 사용하려면 SLACK_WEBHOOK_URL을 GitHub Secrets에 추가하세요
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{
          #     "text": "Hotfix build completed: ${{ needs.build-and-test.result }}",
          #     "attachments": [{
          #       "color": "${{ needs.build-and-test.result == 'success' && 'good' || 'danger' }}",
          #       "fields": [{
          #         "title": "Branch",
          #         "value": "${{ github.ref_name }}",
          #         "short": true
          #       }, {
          #         "title": "Commit",
          #         "value": "${{ github.sha }}",
          #         "short": true
          #       }]
          #     }]
          #   }'

---

# 사용 방법:
#
# 1. 자동 트리거 (hotfix 브랜치 푸시 시)
#    - hotfix/v0.1.1-crash-fix 브랜치에 푸시하면 자동으로 실행됩니다
#
# 2. 수동 트리거
#    - GitHub > Actions > Hotfix Deploy > Run workflow
#    - 버전 입력 (예: 0.1.1)
#
# 3. AAB 다운로드
#    - Actions 탭에서 완료된 워크플로우 클릭
#    - Artifacts 섹션에서 "app-release-aab" 다운로드
#
# 4. Play Console 업로드
#    - 다운로드한 AAB를 Play Console에 수동 업로드
#
# 주의사항:
# - 이 워크플로우는 빌드만 수행하며, Play Console 업로드는 수동으로 해야 합니다
# - 자동 배포를 원하시면 Google Play Developer API 키가 필요합니다
# - Keystore 파일은 GitHub Secrets에 base64로 인코딩하여 저장하세요

# Keystore 설정 방법 (선택사항):
# 1. Keystore를 base64로 인코딩:
#    base64 -i koodtx-release.keystore -o keystore.base64.txt
#
# 2. GitHub > Settings > Secrets and variables > Actions > New repository secret
#    - Name: KEYSTORE_BASE64
#    - Value: (keystore.base64.txt 내용)
#
# 3. Keystore 비밀번호도 Secrets에 추가:
#    - KEYSTORE_PASSWORD
#    - KEY_ALIAS
#    - KEY_PASSWORD
#
# 4. 워크플로우에 디코딩 단계 추가:
#    - name: Decode Keystore
#      run: |
#        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/koodtx-release.keystore

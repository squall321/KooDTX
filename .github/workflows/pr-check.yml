name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: PR Info
        run: |
          echo "### Pull Request Information"
          echo "- PR Number: ${{ github.event.pull_request.number }}"
          echo "- Title: ${{ github.event.pull_request.title }}"
          echo "- Author: ${{ github.event.pull_request.user.login }}"
          echo "- Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "- Head Branch: ${{ github.event.pull_request.head.ref }}"
          echo "- Changed Files: ${{ github.event.pull_request.changed_files }}"

  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Check if PR title starts with conventional commit type
          if echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?:"; then
            echo "âœ… PR title follows conventional commit format"
          else
            echo "âš ï¸ PR title should follow conventional commit format (e.g., 'feat: add new feature')"
            echo "Recommended prefixes: feat, fix, docs, style, refactor, perf, test, chore, ci, build"
          fi

      - name: Check branch naming
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "Branch: $BRANCH_NAME"

          if echo "$BRANCH_NAME" | grep -qE "^(feature|bugfix|hotfix|release|claude)/"; then
            echo "âœ… Branch name follows naming convention"
          else
            echo "âš ï¸ Branch should start with: feature/, bugfix/, hotfix/, release/, or claude/"
          fi

      - name: Check for large files
        run: |
          echo "Checking for large files..."
          if git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD | xargs -I {} du -h {} 2>/dev/null | awk '$1 ~ /[0-9]+M/ { print; found=1 } END { if (found) exit 1 }'; then
            echo "âœ… No large files detected"
          else
            echo "âš ï¸ Large files detected (>1MB). Consider using Git LFS for binary files."
          fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Check formatting
        run: npm run format:check
        continue-on-error: true

      - name: TypeScript check
        run: npm run typecheck

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --ci --coverage --maxWorkers=2

      - name: Coverage summary
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "### Test Coverage Summary"
            cat coverage/coverage-summary.json
          fi

      - name: Comment coverage on PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('coverage/coverage-summary.json')) {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;

              const comment = `### ðŸ“Š Test Coverage Report

              | Metric | Percentage | Covered/Total |
              |--------|-----------|---------------|
              | Statements | ${total.statements.pct}% | ${total.statements.covered}/${total.statements.total} |
              | Branches | ${total.branches.pct}% | ${total.branches.covered}/${total.branches.total} |
              | Functions | ${total.functions.pct}% | ${total.functions.covered}/${total.functions.total} |
              | Lines | ${total.lines.pct}% | ${total.lines.covered}/${total.lines.total} |

              **Overall Coverage:** ${total.lines.pct}%
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  changes-check:
    name: Changed Files Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Analyze changes
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          echo "### Changed Files Analysis"
          echo ""

          # Check for specific file types
          if echo "$CHANGED_FILES" | grep -q "package.json"; then
            echo "ðŸ“¦ package.json modified - Please ensure npm install works"
          fi

          if echo "$CHANGED_FILES" | grep -q "\.test\.\(ts\|tsx\|js\|jsx\)"; then
            echo "ðŸ§ª Test files modified"
          fi

          if echo "$CHANGED_FILES" | grep -q "src/database"; then
            echo "ðŸ—„ï¸ Database files modified - Check migrations if schema changed"
          fi

          if echo "$CHANGED_FILES" | grep -q "App.tsx"; then
            echo "ðŸŽ¯ Main App.tsx modified"
          fi

          if echo "$CHANGED_FILES" | grep -q "\(android\|ios\)/"; then
            echo "ðŸ“± Native code modified - May require native rebuild"
          fi

          echo "âœ… Analysis complete"

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check package size
        run: |
          echo "### Package Size Information"
          du -sh node_modules/ || echo "node_modules size: N/A"
          du -sh src/ || echo "src size: N/A"

          echo ""
          echo "### Top 10 Largest Dependencies"
          du -sh node_modules/* 2>/dev/null | sort -rh | head -10 || echo "Cannot calculate"

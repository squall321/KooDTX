# Rollback Guide

**롤백 가이드** | App Version Rollback Process

이 문서는 KooDTX 앱 업데이트 후 문제가 발생했을 때 이전 버전으로 롤백하는 방법을 설명합니다.

---

## 🔄 롤백이 필요한 경우

### Critical 상황

다음과 같은 경우 즉시 롤백을 고려합니다:

**🔴 즉시 롤백:**
- 새 버전의 크래시율 > 10%
- 핵심 기능 완전 불능 (모든 사용자 영향)
- 데이터 손실 또는 손상 발생
- 보안 취약점 악화
- 이전 버전보다 상황이 악화됨

**🟡 롤백 고려:**
- 새 버전의 크래시율 5-10%
- 특정 기기/OS에서 심각한 문제
- 사용자 리뷰 급격히 악화 (평점 < 3.0)
- Hotfix로 해결 불가능한 복잡한 버그

**🟢 롤백 불필요:**
- 크래시율 < 5%
- 사소한 UI 버그
- Hotfix로 해결 가능한 문제

---

## ⏱️ 롤백 타임라인

**목표: 30분 - 1시간 내 완료**

```
발견 → 결정 → 실행 → 확인 → 사후 조치
  ↓      ↓      ↓      ↓        ↓
  0     10분   20분   40분     1시간+
```

---

## 📋 롤백 프로세스

### Phase 1: 상황 평가 (10분)

#### 1-1. 지표 확인

**Sentry 확인:**
1. https://sentry.io 접속
2. **Issues** 탭 > **Releases** 필터
3. 최신 버전(v0.X.X)의 크래시율 확인

**Play Console 확인:**
1. https://play.google.com/console 접속
2. **품질 > Android vitals**
3. 크래시율, ANR 비율 확인

**비교 기준:**
```
이전 버전(v0.1.0):  크래시율 0.5%
새 버전(v0.2.0):    크래시율 8.0%  ← 롤백 필요!
```

#### 1-2. 사용자 피드백 확인

**Play Console 리뷰:**
- 최근 리뷰에서 크래시/버그 언급 급증 여부
- 평점 하락 여부

**지원 이메일:**
- support@koodtx.com 확인
- 크래시 관련 문의 급증 여부

#### 1-3. 롤백 결정

**롤백 결정 기준:**

| 지표 | 이전 버전 | 새 버전 | 결정 |
|------|----------|---------|------|
| 크래시율 | 0.5% | > 10% | 🔴 즉시 롤백 |
| 크래시율 | 0.5% | 5-10% | 🟡 롤백 고려 |
| 크래시율 | 0.5% | < 5% | 🟢 롤백 불필요 |

**팀 논의 (가능한 경우):**
- Slack/이메일로 긴급 회의
- 롤백 vs Hotfix 결정

---

### Phase 2: Google Play Console 롤백 (10분)

#### 2-1. 출시 중지

1. **Play Console** > **프로덕션** 탭

2. **최신 버전** 찾기 (예: v0.2.0)
   - 버전 코드: 3
   - 상태: "출시됨"

3. **출시 중지** 클릭
   - "이 버전을 중지하시겠습니까?" → **확인**

4. **확인**:
   - 상태가 "중지됨"으로 변경됨
   - 이전 버전(v0.1.0)이 자동으로 활성화됨

#### 2-2. 이전 버전 활성화 확인

**자동 롤백:**
- Google Play는 자동으로 이전 버전(v0.1.0)으로 롤백합니다.
- 별도 작업 불필요!

**확인:**
1. **프로덕션** 탭에서 활성 버전 확인
   - v0.1.0 (versionCode 1): **활성**
   - v0.2.0 (versionCode 3): **중지됨**

2. **통계 > 개요**
   - 활성 버전이 v0.1.0인지 확인

---

### Phase 3: 모니터링 (30분 - 1시간)

#### 3-1. 즉시 확인 (10분)

**Play Console:**
- 활성 버전이 v0.1.0으로 롤백되었는지 확인

**Sentry:**
- 새로운 크래시 발생 감소 추이 확인

#### 3-2. 1시간 후 확인

**지표 개선 확인:**
- 크래시율이 정상 수준(< 1%)으로 회복 중인지 확인
- 신규 설치 사용자는 v0.1.0을 받는지 확인

**주의:**
- 이미 v0.2.0을 설치한 사용자는 자동으로 다운그레이드되지 않습니다!
- 따라서 크래시율이 즉시 0%로 떨어지지 않을 수 있습니다.

#### 3-3. 24시간 후 최종 확인

- 크래시율이 정상 수준으로 회복되었는지 확인
- 사용자 리뷰 개선 여부 확인

---

### Phase 4: 사용자 알림

#### 4-1. Play Console 리뷰 답변

**템플릿:**
```
불편을 드려 죄송합니다.
최신 업데이트에서 발생한 문제로 인해 이전 버전으로 임시 복구했습니다.

현재 앱을 재설치하면 안정적인 버전을 사용하실 수 있습니다.

문제를 수정한 업데이트를 준비 중이니 조금만 기다려 주세요.

감사합니다.
KooDTX 팀
```

#### 4-2. 이메일 알림 (선택사항)

**제목**: `[KooDTX] 긴급 공지: 앱 일시 롤백`

**본문**:
```
안녕하세요,

최근 업데이트(v0.2.0)에서 일부 사용자에게 크래시가 발생하여,
안정적인 이전 버전(v0.1.0)으로 임시 롤백했습니다.

현재 앱 사용 중 문제가 발생하시면:
1. 앱 삭제
2. Play 스토어에서 재설치
→ 안정적인 이전 버전이 설치됩니다.

문제를 수정한 업데이트를 준비 중이니 조금만 기다려 주세요.

불편을 드려 죄송합니다.

감사합니다.
KooDTX 팀
```

#### 4-3. App 내 공지 (선택사항)

**InApp 알림:**
- v0.2.0을 사용 중인 사용자에게만 표시
- "현재 버전에 문제가 발견되었습니다. 앱을 재설치해 주세요."

**구현 예시:**
```typescript
// src/utils/versionCheck.ts
import { Alert } from 'react-native';
import DeviceInfo from 'react-native-device-info';

export const checkForRollback = () => {
  const currentVersion = DeviceInfo.getVersion(); // "0.2.0"

  // 롤백된 버전인지 확인
  if (currentVersion === '0.2.0') {
    Alert.alert(
      '앱 재설치 권장',
      '현재 버전에 문제가 발견되었습니다.\n앱을 재설치하면 안정적인 버전을 사용하실 수 있습니다.',
      [
        { text: '나중에', style: 'cancel' },
        { text: '재설치 방법 보기', onPress: () => showReinstallGuide() }
      ]
    );
  }
};
```

---

### Phase 5: Git 작업

#### 5-1. 롤백 기록

**Git 태그 삭제 (선택사항):**

문제가 있는 버전의 태그를 삭제하고 싶은 경우:

```bash
# 로컬 태그 삭제
git tag -d v0.2.0

# 원격 태그 삭제
git push origin :refs/tags/v0.2.0
```

**주의:** 태그 삭제는 권장하지 않습니다. 이력 추적을 위해 남겨두는 것이 좋습니다.

#### 5-2. GitHub Release 업데이트

1. **GitHub > Releases > v0.2.0** 찾기
2. **Edit release** 클릭
3. **Pre-release** 체크박스 선택
4. **Description에 롤백 사유 추가:**

```markdown
## ⚠️ This release has been rolled back

### Reason
- Critical crash affecting 10% of users
- Issue: [#XX] [문제 설명]

### Action
- Rolled back to v0.1.0
- Fix in progress for v0.2.1

**Do not use this version.**
```

5. **Update release** 클릭

---

## 🛠️ 롤백 후 조치

### 1. 문제 원인 분석 (1-2일)

#### 1-1. 크래시 로그 분석

**Sentry:**
- v0.2.0의 모든 크래시 로그 검토
- 스택 트레이스 분석
- 공통 패턴 찾기

#### 1-2. 재현 시도

- 로컬 환경에서 재현
- 문제 발생 기기/OS 버전에서 테스트

#### 1-3. 근본 원인 파악

- 어떤 변경사항이 문제를 일으켰는가?
- 왜 테스트에서 발견되지 않았는가?

### 2. 수정 및 재배포 (2-3일)

#### 2-1. 버그 수정

- 문제 코드 수정
- 단위 테스트 추가 (재발 방지)

#### 2-2. 철저한 테스트

- 다양한 기기에서 테스트
- 베타 테스터 그룹에게 먼저 배포 (선택사항)

#### 2-3. 버전 배포

- v0.2.1 (PATCH 버전 증가)
- 출시 노트에 "v0.2.0 문제 수정" 명시

### 3. 프로세스 개선

#### 3-1. 회고 (Retrospective)

**질문:**
1. 왜 문제가 발생했는가?
2. 왜 테스트에서 발견되지 않았는가?
3. 어떻게 재발을 방지할 수 있는가?

**Action Items:**
- [ ] 테스트 커버리지 개선
- [ ] 단계적 출시 (Staged Rollout) 활용
- [ ] 베타 테스트 프로그램 도입

#### 3-2. 문서 업데이트

- `docs/ROLLBACK_GUIDE.md` 업데이트 (이 문서)
- 롤백 이력 기록

**Rollback History:**
```markdown
# Rollback History

| 날짜 | 버전 | 문제 | 영향도 | 롤백 시간 | 재배포 버전 |
|------|------|------|--------|----------|------------|
| 2025-01-20 | v0.2.0 | Export crash | 10% users | 30분 | v0.2.1 (2025-01-23) |
```

---

## 🚀 롤백 방지: 단계적 출시 (Staged Rollout)

롤백을 예방하는 가장 좋은 방법은 **단계적 출시**입니다.

### 단계적 출시 설정

1. **Play Console > 프로덕션 > 새 버전 만들기**

2. **AAB 업로드 후:**
   - **"출시 비율"** 설정
   - 초기 출시: **5% 또는 10%**

3. **24시간 모니터링:**
   - Sentry 크래시율 확인
   - Play Console Android vitals 확인
   - 문제 없으면 다음 단계로

4. **단계별 확대:**
   - 1일차: 5%
   - 2일차: 20%
   - 3일차: 50%
   - 4일차: 100%

5. **문제 발견 시:**
   - 즉시 출시 중지
   - 영향 받은 사용자 최소화 (5%만 영향)

---

## ⚠️ 롤백 주의사항

### DO ✅

- **즉시 결정**: 데이터 확인 후 30분 내 롤백 결정
- **모니터링**: 롤백 후 24시간 지속 모니터링
- **사용자 알림**: 문제 인정 및 해결 계획 공유
- **원인 분석**: 철저한 회고 및 재발 방지

### DON'T ❌

- **망설이지 말기**: Critical 상황에서는 즉시 롤백
- **사용자 비난하지 말기**: "기기 문제" 등의 변명 금지
- **같은 실수 반복**: 프로세스 개선 없이 재배포하지 말기

---

## 📊 롤백 이력 트래킹

### CHANGELOG.md

```markdown
# Changelog

## [0.2.1] - 2025-01-23

### Fixed
- v0.2.0에서 발생한 Export 크래시 수정

### Notes
- v0.2.0은 롤백됨 (2025-01-20)

## [0.2.0] - 2025-01-20 [YANKED]

⚠️ This version was rolled back due to critical crashes.

### Added
- 새로운 센서 추가
- 동기화 성능 개선

### Known Issues
- Export 시 10% 사용자 크래시 발생 → v0.2.1에서 수정
```

---

## ✅ 롤백 체크리스트

### 평가 단계
- [ ] Sentry 크래시율 확인
- [ ] Play Console Android vitals 확인
- [ ] 사용자 리뷰 확인
- [ ] 롤백 필요성 판단

### 실행 단계
- [ ] Play Console > 프로덕션 > 최신 버전 "출시 중지"
- [ ] 이전 버전 자동 활성화 확인

### 알림 단계
- [ ] Play Console 리뷰 답변
- [ ] 이메일 알림 (선택사항)
- [ ] In-app 공지 (선택사항)

### Git 작업
- [ ] GitHub Release에 롤백 사유 추가
- [ ] (선택) 태그 삭제 또는 Pre-release 표시

### 모니터링
- [ ] 10분 후: 롤백 완료 확인
- [ ] 1시간 후: 크래시율 감소 확인
- [ ] 24시간 후: 최종 확인

### 사후 조치
- [ ] 문제 원인 분석
- [ ] 버그 수정 (v0.X.X+1)
- [ ] 철저한 테스트
- [ ] 재배포
- [ ] 회고 및 프로세스 개선

---

## 📚 관련 문서

- `docs/HOTFIX_PROCESS.md`: Hotfix 프로세스
- `docs/DAILY_MONITORING_CHECKLIST.md`: 일일 모니터링
- `docs/PHASE_245_250_OPERATIONS.md`: 전체 운영 가이드

---

**마지막 업데이트**: 2025-01-16
**작성자**: KooDTX Team
**버전**: 1.0.0

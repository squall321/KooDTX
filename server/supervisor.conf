; Supervisor Configuration for KooDTX Backend
; /etc/supervisor/conf.d/koodtx.conf 로 복사하여 사용

[group:koodtx]
programs=koodtx-backend,koodtx-celery-worker,koodtx-celery-beat

; =============================================================================
; KooDTX Flask Backend (Gunicorn)
; =============================================================================
[program:koodtx-backend]
command=/home/user/KooDTX/server/venv/bin/gunicorn --config gunicorn_config.py run:app
directory=/home/user/KooDTX/server
user=www-data
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=10
stopasgroup=true
killasgroup=true
stdout_logfile=/var/log/supervisor/koodtx-backend.log
stderr_logfile=/var/log/supervisor/koodtx-backend-error.log
environment=
    PATH="/home/user/KooDTX/server/venv/bin",
    FLASK_ENV="production",
    DATABASE_URL="postgresql://koodtx:password@localhost:5432/koodtx_db",
    REDIS_URL="redis://localhost:6379/0",
    CELERY_BROKER_URL="redis://localhost:6379/0"

; =============================================================================
; Celery Worker
; =============================================================================
[program:koodtx-celery-worker]
command=/home/user/KooDTX/server/venv/bin/celery -A celery_app.celery worker --loglevel=info --concurrency=4
directory=/home/user/KooDTX/server
user=www-data
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=60
stopasgroup=true
killasgroup=true
priority=998
stdout_logfile=/var/log/supervisor/koodtx-celery-worker.log
stderr_logfile=/var/log/supervisor/koodtx-celery-worker-error.log
environment=
    PATH="/home/user/KooDTX/server/venv/bin",
    FLASK_ENV="production",
    DATABASE_URL="postgresql://koodtx:password@localhost:5432/koodtx_db",
    REDIS_URL="redis://localhost:6379/0",
    CELERY_BROKER_URL="redis://localhost:6379/0"

; =============================================================================
; Celery Beat (Scheduler)
; =============================================================================
[program:koodtx-celery-beat]
command=/home/user/KooDTX/server/venv/bin/celery -A celery_app.celery beat --loglevel=info --schedule=/tmp/celerybeat-schedule
directory=/home/user/KooDTX/server
user=www-data
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=10
stopasgroup=true
killasgroup=true
priority=999
stdout_logfile=/var/log/supervisor/koodtx-celery-beat.log
stderr_logfile=/var/log/supervisor/koodtx-celery-beat-error.log
environment=
    PATH="/home/user/KooDTX/server/venv/bin",
    FLASK_ENV="production",
    DATABASE_URL="postgresql://koodtx:password@localhost:5432/koodtx_db",
    REDIS_URL="redis://localhost:6379/0",
    CELERY_BROKER_URL="redis://localhost:6379/0"
